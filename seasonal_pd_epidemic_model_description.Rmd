---
title: "Seasonal Pierce's Disease model"
author: "Adam Zeiliinger"
date: "12/21/19"
output:
  html_document: default
---

## What's new 2019-12-21

\ 

Here's a new model update. I think I've covered all the pieces that we discussed during our chat on 12/19/19.   
1. Maximum time spent in the Exposed compartment is reduced to ~20 weeks.  
2. Reduced baseline external vector infectivity, $\kappa_{\epsilon,0}$, to 0.05.  
3. Modify acquisition rates, $a_I$ and $a_D$, to produce more realistic seasonal infectivity curves.  

\ 



```{r set-options, echo=FALSE, cache=FALSE}
options(width = 120)
```

```{r setup, include=FALSE}
my.packages <- c("ggplot2", "raster", "dplyr", "tidyr", "data.table", "cowplot")
lapply(my.packages, require, character.only = TRUE)

#### Source Seasonal PD model function
source("epidemic_simulations/simulation_functions/seasonalPDmodel.R")

#### Source child functions, required to run seasonalPDModel()
## seasonal_vector_density_functions also includes hostRecovery() function
source("epidemic_simulations/simulation_functions/seasonal_vector_density_functions.R")
## Dispersal kernel functions, also includes makeCoordinates() function
source("epidemic_simulations/simulation_functions/dispersal_kernel_functions.R")
source("epidemic_simulations/simulation_functions/factor2numeric.R")

```

## Host compartments

The model consists of a spatially explicit, discrete-time SEIDS host compartments. Susceptible hosts become infected and move to the Exposed (or latently infected) compartment according to a force of infection $\lambda_{i}(t)$. After a latent period, host i moves into the I, or Infectious, compartment and can now contribute to transmitting the pathogen to other hosts (through vectors). However, hosts in the Infectious compartment are considered asymptomatic. Then after some post-latent incubation period, host i moves into the D, or Diseased, compartment where it remains infectious but now also symptomatic. This framework is based on Parry et al. (2014). In additon, hosts in any infected compartment (E, I, D) can recover and become Susceptible again.

\ 

### Adrakey model for force of infection

At its core, we are modeling the instantaneous force of infection of susceptible plant $i$ in the interval between time $t$ to $t + dt$, $\lambda_{i}(t)$, as a function of secondary or vine-to-vine spread rate $\beta$, dispersal scale parameter $\alpha$, and external or primary rate of infection $\epsilon$:

$$
\begin{align}
\lambda_i(t) &= \beta_{i}(t) + \epsilon_{i}(t) \\
\end{align}
$$

\ 

### Transitions among compartments are stochastic
#### Sellke threshold construction

Assume that each susceptible plant $i$ has a threshold of resistance $Q_{i}$ which are exponentially distributed and independent of each other: $Q_{i}\sim\exp(1)$. The cumulative pressure on plant $i$ by time $t$ is given by: 
$$A_i(t)=\int_{0}^{t}\lambda_{i}(u)du$$
Then plant $i$ becomes latently infected at time $t$ when $Q_{i}=A_{i}(t)$. In this way, we relate the force of infection upon a plant to its infection status in a stochastic manner (Adrakey et al. 2017; Sellke 1983).

\ 

#### Infectious and Diseased compartment transitions

The transition from Exposed to Infectious depends on what time in the growing season a plant becomes Exposed. The time a plant spends in the Exposed compartment takes a quadratic or "U shaped" form, with long latent periods when first Exposed at the beginning and end of the year, and shorter latent periods in the summer months. I add a small amount of (gamma distributed) noise to the durations (i.e., latent periods). The transition from Infectious to Diseased works in the same way, except that the minimum and maximum durations are smaller.


```{r, fig.align='center', fig.cap='Relationship between time of season plant became moved into Exposed (A) or Infectious (B) and the duration of time spent in the compartment', fig.height=14}

## Durations of stays in Exposed compartment
Exposed_noise <- rgamma(900, shape = 2, scale = 1)
#hist(Exposed_noise)
#mean(Exposed_noise)

Inf_noise <- rgamma(900, shape = 1, scale = 0.5)
#qplot(Inf_noise, geom = "histogram", binwidth = 0.25)
#mean(Inf_noise)

testTimes <- runif(900, min = 1, max = 52)
Exposed_time <- transitionPeriod(a = 8, c = 0.004, t = testTimes) + Exposed_noise
TransitionData <- data.frame(testTimes = testTimes,
                             Exposed_time = Exposed_time,
                             Infectious_time = (transitionPeriod(a = 2, c = 0.002, t = testTimes) + Inf_noise))

EtDurationsPlot <- ggplot(data = TransitionData, aes(x = testTimes/4, y = Exposed_time)) +
  geom_point() +
  scale_x_continuous(name = "Month that plant became Exposed (infected)") +
   scale_y_continuous(name = "Time spent in Exposed compartment (weeks)") +
   theme_bw(base_size=12) +
   theme(axis.line = element_line(colour = "black"),
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         panel.border = element_rect(colour = "black"),
         panel.background = element_blank(),
         legend.position = "none") 
EtDurationsPlot

## Durations of stays in Infectious compartment
ItDurationsPlot <- ggplot(data = TransitionData, aes(x = testTimes/4, y = Infectious_time)) +
  geom_point() +
  scale_x_continuous(name = "Month that plant became Infectious") +
   scale_y_continuous(name = "Time spent in Infectious compartment (weeks)") +
   theme_bw(base_size=12) +
   theme(axis.line = element_line(colour = "black"),
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         panel.border = element_rect(colour = "black"),
         panel.background = element_blank(),
         legend.position = "none") 

plot_grid(EtDurationsPlot, ItDurationsPlot,
          nrow = 2, ncol = 1, label_x = 0.07, label_y = 0.95,
          labels = c("A", "B"))

```

\ 

## Incorporating vector density and infectivity

Assume that the external infection rate $\epsilon$ and secondary infection rate $\beta$ are time-dependent functions of vector density and infectivity. This is inspired by Parry et al. (2014), who used a similar model to Adrakey et al., but deviates from their exact formulation.

\ 

#### External infection rate:

$$
\begin{align}
\text{Time-dependent external infection rate for plant i} \\
\epsilon_{i}(t) &= \eta \kappa \cdot \rho_{\epsilon}(t) \cdot K(D_{i}, \alpha) \\
\text{where } \rho_{\epsilon}(t) \text{ is a piecwise function as follows}: \\
\rho_{\epsilon}(t)= \left\{
\begin{array}{ll}
  \tilde{\rho}(t) & \tilde{\rho}(t)>0 \\
  \ 0 & otherwise \\
\end{array}
\right. \\
\text{with} \\
\tilde{\rho}(t) &= A \cdot \exp(-\lambda t) \cdot \sin(\phi \pi t) \\
\text{Dispersal function:} \\
\ K(d,\alpha) &= \frac{1}{2 \pi d \alpha} \cdot \exp(-\frac{d}{\alpha}) \\
\end{align}
$$

Here, $\eta$ is the vector inoculation rate, $\kappa$ is the proportion of external vectors that are infectious, $K(D_{i},\alpha)$ is the immigrant dispersal kernel function, and $\rho_{\epsilon}(t)$ is the average density (per plant) of immigrating external vectors from border vegetation. The immigrant dispersal kernel function currently takes a normalized exponential form. This was the best disperal function in the analysis of Neri et al. (2014), but others could be used. The distance $D_{i}$ is the distance from plant $i$ to the nearest border of the field, and $\alpha$ is the dispersal scaling parameter. This form assumes that immgrating vectors are more likely to land on a plant near the field border than further inside the field.

```{r}

## Example immigrant vector dispersal
alpha <- 10 # Dispersal parameter

#### Plant spatial coordinates
## Total number of plants (numPlants) = nrow(Coo) = nrc*nrc
nrc <- 50 # Number of rows/columns
Coo <- makeCoordinates(nrc)

## Calculating distance to nearest field border for each plant
borderCoo <- rep(c(1,nrc), each = 2)
borderD <- apply(Coo, 1, function(x) min(sqrt((x - borderCoo)^2))+1)
## Add 1 to the distance; plants on the border are then 1 space from the border and all other plants are shifted accordingly
## Dispersal distances from border
epsilonK <- chooseKernel(d = borderD, alpha = alpha, kernelFunc = "normalized exponential")
qplot(borderD,epsilonK,geom="path", xlab="Distance from border", ylab="K(D,alpha)")

```

\ 
The density of immigrating vectors (per plant), $\rho_{\epsilon}(t)$, takes the form of a damped sine wave. The idea is to replicate the generational peaks of BGSS in the border vegetation observed in North Coast data set. This is a pretty crude phenomenological approach and probably needs more detail. Nonetheless with the right parameter values we can get a good approximation of the dynamics within 1 year. The piecewise element is to ensure that the function doesn't produce negative densities; a value greater than zero could also be specified for the "baseline".

```{r}

vectorDensity <- function(A, lambda_osc, phi, base = 0, time){
  rho <- A*exp(-lambda_osc*time)*sin(phi*pi*time)
  ## set negative numbers to zero
  rho <- ifelse(rho < base, base, rho)
  return(rho)
}

timeVec <- seq(1,52,0.1)
rho_et <- vectorDensity(A = -40, lambda_osc = 0.05, phi = 0.09, base = 0.1, time = timeVec)
qplot(timeVec/4, rho_et, xlab = "Week", ylab = "Immigrating vector density", geom = "path")

```

\ 

#### Secondary infection rate


$$
\begin{align}
\text{Time-dependent secondary infection rate} \\
\beta(t) &= \eta \kappa_{\beta}(t) \cdot \rho_{\beta}(t) \cdot \sum_{j \in I(t)} K(d_{i,j},\alpha)\\
\text{where} \\
\kappa_{\beta}(t) &= \frac{a_{I}I(t-1) + a_{D}D(t-1)}{N} \\
\rho_{\beta}(t) &= (1 - \mu_{v}) \cdot (\rho_{\beta}(t-1) + \rho_{\epsilon}(t-1)) \\
\ K(d_{i,j},\alpha) &= \frac{1}{2 \pi d \alpha} \cdot \exp(-\frac{d}{\alpha}) \\
\end{align}
$$

Here, $\eta$ is the same inoculation rate as above. But now $\kappa_{\beta}(t)$ is the time-dependent proportion of in-field vectors infectious, and is a function of the density of Infectious grapevines at the previous time step $\frac{I(t-1)}{N}$, the density of Diseased grapevines at the previous time step $\frac{D(t-1)}{N}$, and compartment-specific acquisition rates, $a_{I}, a_{D}$. The different acquisition rates imply that Diseased grapevines will have greater Xylella populations than Infectious grapevines, so acquisition rates from Diseased grapevines should be greater. The density of in-field vectors, $\rho_{\beta}(t)$, is a function of the density of in-field vectors at the previous time step, $\rho_{\beta}(t-1)$, the density of immigrating vectors at the previous time step, $\rho_{\epsilon}(t-1)$, and the loss rate of vectors, $\mu_{v}$, due to death and emmigration. This assumes that reproduction in field is negligible. The dispersal function $K(d_{i,j},\alpha)$ takes the same form as the immigrating dispersal function but here $d{i,j}$ is the distance from susceptible plant $i$ and infected plant $j$, which is then summed up over all $j$ infected plants.

\ 

## Inter-annual processes

At the end of each growing season (i.e., winter), we assume that winter recovery, plant dormancy, plant roguing, and vector overwintering occur instantaeously. This is similar to the assumptions of Daugherty and Almeida (2019), Gruber and Daugherty (2013), and the impulse equations of Rozins and Day (2016). 

#### Winter recovery and dormancy

We assume that the probability of winter recovery for plant $i$, $P_{i}^R$, is a function of infection time ($t$, day of year), specifically the time that it moved into the Exposed compartment during the growing season, according to the functional response from Feil et al. (2003):
$$P_{i}^R = (1 - e^{bt})^{135.9}$$

The recovery probability curve, $P_{i}^R$ can be shifted left or right with the parameter $b$. The default value is $b = -0.045$ from Feil et al. 2003. More negative values shift the curve to the left, meaning that plants with earlier infection times are more likely to recover; less negative values shift the curve to the right, making recovery less likely except for very late infections.


```{r}

hostRecovery <- function(time, b = -0.045){
  ## The curve can be shifted by modifying the value of parameter b
  ## More negative values of b shift curve to the left, less negative values shift to the right.
  ## Default value is estimate from Feil et al. 2003
  (1 - exp(b*time))^135.9
}

timestep <- 1:365
test <- hostRecovery(timestep, b = -0.045)
qplot(x = timestep/7, y = test, geom = "path", xlab = "Week", ylab = "Probability of winter recovery")

```

\ 

Recovery status of plant $i$ is then a random binomial variable with probability $P_{i}^R$. If plant i recovers, it then reverts back to Susceptible. If plant i does not recover it remains in the Exposed compartment (or reverts back to the Exposed compartment if it had moved into the Infectious or Diseased compartments within the year). Starting at the beginning of the next year, plants that remain infected then progress into the Infectious (and Diseased) compartments after a latent or post-latent incubation period, $t_{i}^I, t_{i}^D$. These plants are then considered chronically infected. They are eligible to recover the next winter with very low probability (we could easily exclude them from recovery if we want).

All plants that remain chronically infected and have progressed to the Infectious or Diseased compartments revert back to the Exposed compartment. They then progress into the Infectious and Diseased compartments again after another set of latent and post-latent incubation periods. Currently, new periods, $t_{i}^I, t_{i}^D$, are randomly assigned (according to Gamma distributions, above) each new growing season. This induces year-to-year stochasticity in the progression of plants into the different compartments.

\ 

#### Vector overwintering

At the start of each growing season (after the first year), the natural infectivity of immigrating vectors, $\kappa_{\epsilon}(t)$, is the sum of the baseline external vector infectivity, $\kappa_{\epsilon,0}$, and infectivity of overwintering in-field vectors, $\kappa_{\beta}(T_{w}^+)$. As the season progresses, overwintering vector infectivity decays exponentially such that by about May or June, the contribution of $\kappa_{\beta}(T_{w}^+)$ is negligible.

Vector overwintering can be "turned on" or "turned off" with the logical flag "vectorOverwintering".

```{r vector_overwintering_decay_function, fig.align='center', fig.cap='Decay of infectivity from overwintering vectors'}

VOdecay <- function(kappa_b, a = 4, t){
  kappa_b*exp(-t/a)
}

kappa_b <- 0.6
t <- 1:52
test <- VOdecay(kappa_b, a = 6, t = t)
qplot(t/4,test,geom="path", xlab="month", ylab="Contribution from kappa_beta")

```



\ 

#### Roguing and replacing diseased vines

At the end of each growing season, we assume that some total number of sympomatic vines, are removed and replaced with new Susceptible vines. Only plants in the Diseased compartment are eligible for roguing. By setting a total number of vines to be rogued, rather than a proportion of diseased vines, we assume that managers have limited time and resources to rogue. So if the number of disease vines exceeds the number to be rogued, some disease vines are left in the field. In this case, a random sub-sample of Diseased vines revert back to the Susceptible compartment. The total number of vines to be rogued can be varied. Roguing can be "turned off" by setting the variable numPlantsRogued = 0.

\ 

## Running the model
#### Setting parameter values

```{r global_model_parameters, echo = TRUE, include = TRUE}

parameterList <- list(
  #### Parameter values
  ## In this version, epsilon and beta are functions of other parameters, define non-varying parameters here
  alpha = 10, # Dispersal parameter
  eta = 0.5, # Inoculation rate (LAMBDA in Parry et al.)
  kappa_e0 = 0.05, # Proportion of external vectors infectious
  aI = 0.6, # Acquisition rate from Infectious hosts
  aD = 0.6, # Acquisition rate from Diseased hosts; aD should be >= aI because of Xylella population growth
  muv = 0.1, # In-field loss rate of vectors (due to both death and emigration)
  ### Parameter values for vectorDensity() damped sine wave
  A = -40, # Initial amplitude
  lambda_osc = 0.05, # Dampening
  phi = 0.09, # Angular frequency
  base = 0.1, # Baseline vector density
  #### Winter recovery
  b = -0.045 # Shifting the recovery curve
)

## Number of time steps; assume each time step is 1 week
Tmax <- 52

## Number of years
numYears <- 5

## Number of plants on a row or column
nrc <- 30


```


#### Multiple simulation runs

```{r running_the_model}

## Number of simulations for each scenario
nruns <- 5

#### Important values for processing simulations
numPlants <- nrc^2
timeSteps <- 1:(Tmax*numYears)
## Vector of week number at the end of years, to produce vertical lines on ggplot
endOfYears <- data.frame(timeStep = Tmax*1:numYears)
## Vector of each time step (weeks)
weekVector <- data.frame(timeStep = timeSteps)

## Create empty lists for simulation results
simList <- blRatioList <- vector("list", nruns)

#### Model run with vector overwintering and roguing
#### Data frames of the different outputs from the simulations
ExposureTimesData1 <- InfectiousTimesData1 <- DiseaseTimesData1 <- matrix(NA, nrow = length(timeSteps), ncol = nruns)
kappa_b_Data1 <- kappa_e_Data1 <- matrix(NA, nrow = length(timeSteps), ncol = nruns)

for(i in 1:nruns){
  print(paste("On simulation run ", i, sep = ""))
  simList[[i]] <- seasonalPDmodel(parameterList,
                                  nrc = nrc,
                                  Tmax = Tmax,
                                  numYears = numYears,
                                  numPlantsRogued = 0, # No roguing
                                  vectorOverwintering = TRUE,
                                  verbose = TRUE)
  # saveRDS(simList, file = "output/epidemic_simulation_test_results_list.rds")
  # simList <- readRDS("output/epidemic_simulation_test_results_list.rds")
  #### Processing simulation results
  kappa_b_Data1[,i] <- c(simList[[i]]$kappa_b_matrix)
  kappa_e_Data1[,i] <- c(simList[[i]]$kappa_e_matrix)
  #### Extracting and processing ExposureMatrix results from each run
  ExpTimesProcessed <- processInfectionTimes(simList[[i]]$ExposureMatrix, numYears, Tmax, weekVector)
  ## Save just the cumulative infections times from each simulation, for now
  ExposureTimesData1[,i] <- ExpTimesProcessed$cumulInfections
  #### Extracting and processing InfectiousMatrix results from each run
  InfTimesProcessed <- processInfectionTimes(simList[[i]]$InfectiousMatrix, numYears, Tmax, weekVector)
  ## Save just the cumulative infections times from each simulation, for now
  InfectiousTimesData1[,i] <- InfTimesProcessed$cumulInfections
  #### Extracting and processing DiseaseMatrix results from each run
  DiseaseTimesProcessed <- processInfectionTimes(simList[[i]]$DiseaseMatrix, numYears, Tmax, weekVector)
  ## Save just the cumulative infections times from each simulation, for now
  DiseaseTimesData1[,i] <- DiseaseTimesProcessed$cumulInfections
  ## Save the ratio of beta:lambda for the last year of the simulation, averaged over plants
  betaMatrix <- simList[[i]]$betaMatrix
  epsilonMatrix <- simList[[i]]$epsilonMatrix
  blRatio <- betaMatrix/(betaMatrix+epsilonMatrix)
  blRatio <- ifelse(is.nan(blRatio), 0, blRatio) # Handle cases where lambda (beta + epsilon) == 0
  blRatioList[[i]] <- as.data.frame(t(colMeans(blRatio)))
}


```

\ 

The simulation was run for `r numYears` years, with a time step of 1 week (i.e., 52 time steps), on a vineyard of `r nrc` x `r nrc` = `r nrc*nrc` plants. The simulation was repeated `r nruns` times. 

In the figure below, green squares are healthy plants at the end of the simulation, with the other colors indicating the time (week within the season) of that each plants became diseased: lighter colors indicate earlier disease times. I also set immigration of vectors from only 1 border. 

\ 

```{r disease_map, fig.cap = "Raster map of time to disease of each plant", fig.align="center"}
#### Pick a simulation at random
randsim <- sample(1:nruns, 1)
Coo <- simList[[randsim]]$Coo
Disease_times <- rowMeans(simList[[randsim]]$DiseaseMatrix)

#### Produce raster with infection times as values
## Get raster dimensions from Coo
## Coo[,1] = rows or y coord
## Coo[,2] = columns or x coord
CooRows <- Coo[,1]
CooNrows <- length(unique(CooRows))
CooYmn <- min(CooRows)
CooYmx <- max(CooRows)
CooColumns <- Coo[,2]
CooNcols <- length(unique(CooColumns))
CooXmn <- min(CooColumns)
CooXmx <- max(CooColumns)

rasterTimes <- raster(nrows = CooNrows, ymn = CooYmn, ymx = CooYmx,
                      ncols = CooNcols, xmn = CooXmn, xmx = CooXmx,
                      vals = Disease_times)
plot(rasterTimes, main = "Average week of year plant became diseased")

```

\ 

#### Infection dynamics (of each class) over time


```{r, fig.cap = "Cumulative number of latent infections (A), asymptomatic infections (B), and diseased plants (C). Vertical dashed lines indicate the end of each year", fig.align = "center", fig.height=21}

#### Cumulative latent infection times (Exposed compartment)
#### Calculate mean exposure times across simulations
meanTimes <- data.frame(timeStep = timeSteps,
                        meanExposedPlants = rowMeans(ExposureTimesData1),
                        meanInfectiousPlants = rowMeans(InfectiousTimesData1),
                        meanDiseasedPlants = rowMeans(DiseaseTimesData1))

#### Final percentage of plants infected
percInfected <- 100*meanTimes[meanTimes$timeStep == max(meanTimes$timeStep), "meanExposedPlants"]/numPlants

#### Gather simulations for plotting each one as a separate line
plotSimsExposures <- ExposureTimesData1 %>% as.data.frame() %>%
  mutate(timeStep = timeSteps) %>%
  pivot_longer(starts_with("V"), names_to = "simulation", values_to = "cumulInfections", names_prefix = "V")

plotSimsInfectious <- InfectiousTimesData1 %>% as.data.frame() %>%
  mutate(timeStep = timeSteps) %>%
  pivot_longer(starts_with("V"), names_to = "simulation", values_to = "cumulInfections", names_prefix = "V")

plotSimsDiseased <- DiseaseTimesData1 %>% as.data.frame() %>%
  mutate(timeStep = timeSteps) %>%
  pivot_longer(starts_with("V"), names_to = "simulation", values_to = "cumulInfections", names_prefix = "V")


#### Build panels
ExpDynamicsPlot <- ggplot(data = plotSimsExposures, aes(x = timeStep, y = cumulInfections)) +
  geom_path(aes(group = simulation), lwd = 1, colour = "grey", alpha = 0.75) +
  geom_path(data = meanTimes, aes(x = timeStep, y = meanExposedPlants), colour = "black", lwd = 2) +
  ## Add vertical lines indicating the end of each growing season/year
  geom_vline(data = endOfYears, aes(xintercept = timeStep), linetype = 2) +
  scale_y_continuous(name = "Mean cumulative number",
                     sec.axis = sec_axis(~./numPlants, name = "Mean proportion of plants")) +
  ggtitle("Latent infection (Exposed) times") +
  theme_bw(base_size=10) +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black"),
        panel.background = element_blank(),
        legend.position = "none")
ExpPlotAll <- ExpDynamicsPlot + scale_x_continuous(name = "")


InfDynamicsPlot <- ggplot(data = plotSimsInfectious, aes(x = timeStep, y = cumulInfections)) +
  geom_path(aes(group = simulation), lwd = 1, colour = "grey", alpha = 0.75) +
  geom_path(data = meanTimes, aes(x = timeStep, y = meanInfectiousPlants), colour = "black", lwd = 2) +
  ## Add vertical lines indicating the end of each growing season/year
  geom_vline(data = endOfYears, aes(xintercept = timeStep), linetype = 2) +
  scale_y_continuous(name = "Mean cumulative number",
                     sec.axis = sec_axis(~./numPlants, name = "Mean proportion of plants")) +
  ggtitle("Asymptomatic Infectious times") +
  theme_bw(base_size=12) +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black"),
        panel.background = element_blank(),
        legend.position = "none")
InfPlotAll <- InfDynamicsPlot + scale_x_continuous(name = "")

#InfDynamicsPlot

DiseaseDynamicsPlot <- ggplot(data = plotSimsDiseased, aes(x = timeStep, y = cumulInfections)) +
  geom_path(aes(group = simulation), lwd = 1, colour = "grey", alpha = 0.75) +
  geom_path(data = meanTimes, aes(x = timeStep, y = meanDiseasedPlants), colour = "black", lwd = 2) +
  ## Add vertical lines indicating the end of each growing season/year
  geom_vline(data = endOfYears, aes(xintercept = timeStep), linetype = 2) +
  scale_y_continuous(name = "Mean cumulative number",
                     sec.axis = sec_axis(~./numPlants, name = "Mean proportion of plants")) +
  ggtitle("Disease times") +
  theme_bw(base_size=12) +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black"),
        panel.background = element_blank(),
        legend.position = "none")
DiseasePlotAll <- DiseaseDynamicsPlot + scale_x_continuous(name = "Weeks")

#DiseaseDynamicsPlot

## Build multi-panel plot
plot_grid(ExpPlotAll, InfPlotAll, DiseasePlotAll,
          ncol = 1, nrow = 3, label_x = 0.07, label_y = 0.95, 
          labels = c("A", "B", "C"), label_size = 15)

```

\ 

#### Dynamics of vector natural infectivity

The figure below shows the dynamics of vector infectivity (in-field + immigrating) over all years. Note the small y-axis scale.

```{r vector_infectivity, fig.align="center", fig.cap="Total vector infectivity", echo = FALSE}

#### Kappa values for each time step
kappaData <- data.frame(timeStep = timeSteps,
                        kappa_b = rowMeans(kappa_b_Data1),
                        kappa_e = rowMeans(kappa_e_Data1),
                        kappa = rowMeans(kappa_b_Data1) + rowMeans(kappa_e_Data1))

#### Gather simulations for plotting each one as a separate line
plotKappaSims <- kappa_b_Data1 + kappa_e_Data1 %>% as.data.frame() %>%
  mutate(timeStep = timeSteps) #%>%
plotKappaSims <- plotKappaSims %>% pivot_longer(starts_with("V"), names_to = "simulation", values_to = "kappa", names_prefix = "V")


kappaPlot <- ggplot(data = plotKappaSims, aes(x = timeStep, y = kappa)) +
  geom_line(aes(group = simulation), lwd = 1, colour = "grey", alpha = 0.75) +
  geom_path(data = kappaData, aes(x = timeStep, y = kappa), colour = "black", lwd = 2) +
  geom_vline(data = endOfYears, aes(xintercept = timeStep), linetype = 2) +
  scale_y_continuous(name = "Proportion of in-field vectors infectious") + #, limits = c(0,1)) +
  theme_bw(base_size=16) +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black"),
        panel.background = element_blank(),
        legend.position = "none") 
kappaPlot + scale_x_continuous(name = "Weeks")


```

\ 

#### Vector infectivity detail

The figure below shows the dynamics of vector infectivity (in-field + immigrating) for the year 3 only. Note the small y-axis scale.

```{r vector_infectivity_detail, fig.align="center", fig.cap="Total vector infectivity, year 3 only", echo = FALSE, warning=FALSE}

kappaPlot + scale_x_continuous(name = "Weeks", limits = endOfYears$timeStep[3:4])

```


```{r, influde = FALSE, eval = FALSE, fig.align = "center", fig.cap = "Number of new infections scaled by vector density. Note, chronic infections were removed from figure"}

#### Add vector density to infection times data set
## rho_btVec is a vector of densities of length Tmax; as long as nrow(infectionTimes) is a multiple of Tmax, rho_btVec values will be recycled
infectionTimes$vectorDensity <- rho_btVec
infectionTimes$scaledInfections <- with(infectionTimes, numInfections/vectorDensity)

#### Remove chronic infections -- can be accomplished by removing the last week of each year
infectionTimes <- infectionTimes[!(infectionTimes$timeStep %in% endOfYears$timeStep),]

ggplot(data = infectionTimes, aes(x = timeStep, y = scaledInfections)) +
  geom_path(lwd = 1) +
  geom_vline(data = endOfYears, aes(xintercept = timeStep), linetype = 2) +
  scale_x_continuous(name = "Week") +
  scale_y_continuous(name = "Number of new latent infections per vector") +
  theme_bw(base_size=16) +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black"),
        panel.background = element_blank(),
        legend.position = "none") 

```

\ 

```{r, include = FALSE, eval = FALSE, fig.align='center', fig.cap='Distribution of times (week within season) that plants became Infectious (A) or Diseased (B)'}

#### Calculate mode of Disease times for each plant across simulation runs
Inf_times <- sapply(InfectiousData1, mfv)
plotInfectiousTimes <- data.frame(iTimes = Inf_times[Inf_times < Tmax])

InfTimesDistPlot <- ggplot(plotInfectiousTimes, aes(x = iTimes)) +
  geom_histogram(binwidth = 1) +
  scale_x_continuous(name = "Week plant became Infectious", limits = c(0,60)) +
  scale_y_continuous(name = "Frequency") +
  theme_bw(base_size=16) +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black"),
        panel.background = element_blank(),
        legend.position = "none") 


#### Calculate mode of Disease times for each plant across simulation runs
Disease_times <- sapply(DiseaseData1, mfv)
plotDiseaseTimes <- data.frame(dTimes = Disease_times[Disease_times < Tmax])

DiseaseTimesDistPlot <- ggplot(plotDiseaseTimes, aes(x = dTimes)) +
  geom_histogram(binwidth = 1) +
  scale_x_continuous(name = "Week plant became Diseased", limits = c(0,60)) +
  scale_y_continuous(name = "Frequency") +
  theme_bw(base_size=16) +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black"),
        panel.background = element_blank(),
        legend.position = "none") 

plot_grid(InfTimesDistPlot, DiseaseTimesDistPlot,
          ncol = 1, nrow = 2, hjust = -0.5,
          labels = c("A", "B"), label_size = 15)

```

\ 


#### Relative importance of vine-to-vine spread and external infection rates over the season

```{r beta_lambda_ratio, fig.align="center", fig.cap="Beta:Lambda ratio, for the last year only, averaged over plants and simulations"}

plotBL <- data.frame(week = 1:Tmax,
                     blRatio = colMeans(rbindlist(blRatioList)))

ggplot(data = plotBL, aes(x = week, y = blRatio)) +
  geom_path(colour = "black", lwd = 1) +
  geom_hline(yintercept = 0.5, linetype = 2) +
  scale_x_continuous(name = "Weeks") +
  scale_y_continuous(name = "Beta/(Beta+Epsilon)", limits = c(0,1)) +
  theme_bw(base_size=16) +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black"),
        panel.background = element_blank(),
        legend.position = "none") 
```

\ 


