---
title: "Comparing Seasonal PD Model Simulations"
author: "Adam Zeiliinger"
date: "11/27/2019"
output:
  html_document: default
---

## Comparing model runs

This report compares the results of three different model scenario:  
1. A "base model run" without vectors overwintering (i.e., no inter-annual carryover of vectors) and no roguing  
2. Base model including vector overwintering  
3. Base model including vector overwintering and roguing  

\ 

Because this is a stochastic model, we run 20 simulations of each scenario and look at summary statistics (mostly mean values) from these runs.

\ 

```{r setup, include = FALSE, echo=TRUE, results = FALSE}
my.packages <- c("ggplot2", "raster", "dplyr", "tidyr", "data.table", "modeest")
lapply(my.packages, require, character.only = TRUE)

#### Source Seasonal PD model function
source("epidemic_simulations/simulation_functions/seasonalPDmodel.R")

#### Source child functions, required to run seasonalPDModel()
## seasonal_vector_density_functions also includes hostRecovery() function
source("epidemic_simulations/simulation_functions/seasonal_vector_density_functions.R")
## Dispersal kernel functions, also includes makeCoordinates() function
source("epidemic_simulations/simulation_functions/dispersal_kernel_functions.R")
source("epidemic_simulations/simulation_functions/factor2numeric.R")

```

\ 

#### Global model parameters

```{r global_model_parameters, echo = TRUE, include = TRUE}

parameterList <- list(
  #### Parameter values
  ## In this version, epsilon and beta are functions of other parameters, define non-varying parameters here
  alpha = 10, # Dispersal parameter
  eta = 0.5, # Inoculation rate (LAMBDA in Parry et al.)
  kappa_e = 0.6, # Proportion of external vectors infectious
  aI = 0.5, # Acquisition rate from Infectious hosts
  aD = 0.7, # Acquisition rate from Diseased hosts; aD should be >= aI because of Xylella population growth
  muv = 0.3, # In-field loss rate of vectors (due to both death and emigration)
  ### Parameter values for vectorDensity() damped sine wave
  A = -15, # Initial amplitude
  lambda_osc = 0.05, # Dampening
  phi = 0.09, # Angular frequency
  base = 0.1, # Baseline vector density
  #### Winter recovery
  b = -0.045, # Shifting the recovery curve
  muv_e = 0.5 # Vector overwintering mortality
)

## Number of time steps; assume each time step is 1 week
Tmax <- 52

## Number of years
numYears <- 5

## Number of plants on a row or column
nrc <- 30


```

\ 

Each variant is run for `r numYears` years with a time step of 1 week (`r Tmax` time steps per year) on a vineyard with `r nrc` x `r nrc` = 900 plants.

\ 

## Running all three model scenarios 

```{r model_runs, echo = TRUE, results = FALSE}

## Number of simulations for each scenario
nruns <- 20

#### Important values for processing simulations
numPlants <- nrc^2
timeSteps <- 1:(Tmax*numYears)
## Vector of week number at the end of years, to produce vertical lines on ggplot
endOfYears <- data.frame(timeStep = Tmax*1:numYears)
## Vector of each time step (weeks)
weekVector <- data.frame(timeStep = timeSteps)

## Create empty lists for simulation results
sim1List <- sim2List <- sim3List <- vector("list", nruns)


#### 1. Model run without vector overwintering or roguing
#### Data frames of the different outputs from the simulations
DiseaseData1 <- matrix(NA, nrow = numPlants, ncol = nruns)
infectionTimesData1 <- kappaData1 <- matrix(NA, nrow = length(timeSteps), ncol = nruns)

for(i in 1:nruns){
  # sim1List[[i]] <- seasonalPDmodel(parameterList,
  #                                  nrc = nrc,
  #                                  Tmax = Tmax,
  #                                  numYears = numYears,
  #                                  numPlantsRogued = 0, # No roguing
  #                                  vectorOverwintering = FALSE) # No vector overwintering
  # saveRDS(sim1List, file = "output/epidemic_simulation_scenario1_results_list.rds")
  sim1List <- readRDS("output/epidemic_simulation_scenario1_results_list.rds")
  #### Processing simulation results
  DiseaseData1[,i] <- sim1List[[i]]$Disease_times
  kappaData1[,i] <- c(sim1List[[i]]$kappaMatrix)
  #### Extracting and processing Exp_times results from each run
  infTimesProcessed <- processLatentInfections(sim1List[[i]]$Exp_times, numYears, Tmax, weekVector)
  ## Save just the cumulative infections times from each simulation, for now
  infectionTimesData1[,i] <- infTimesProcessed$cumulInfections
}



#### 2. Model run with vector overwintering
#### Data frames of the different outputs from the simulations
DiseaseData2 <- matrix(NA, nrow = numPlants, ncol = nruns)
infectionTimesData2 <- kappaData2 <- matrix(NA, nrow = length(timeSteps), ncol = nruns)

for(i in 1:nruns){
  # sim2List[[i]] <- seasonalPDmodel(parameterList, 
  #                                  nrc = nrc, 
  #                                  Tmax = Tmax, 
  #                                  numYears = numYears, 
  #                                  numPlantsRogued = 0, # No roguing
  #                                  vectorOverwintering = TRUE) # Vector overwintering
  # saveRDS(sim2List, file = "output/epidemic_simulation_scenario2_results_list.rds")
  sim2List <- readRDS("output/epidemic_simulation_scenario2_results_list.rds")
  #### Processing simulation results
  DiseaseData2[,i] <- sim2List[[i]]$Disease_times
  kappaData2[,i] <- c(sim2List[[i]]$kappaMatrix)
  #### Extracting and processing Exp_times results from each run
  infTimesProcessed <- processLatentInfections(sim2List[[i]]$Exp_times, numYears, Tmax, weekVector)
  ## Save just the cumulative infections times from each simulation, for now
  infectionTimesData2[,i] <- infTimesProcessed$cumulInfections
}


#### 3. Model run with vector overwintering and roguing
#### Data frames of the different outputs from the simulations
DiseaseData3 <- matrix(NA, nrow = numPlants, ncol = nruns)
infectionTimesData3 <- kappaData3 <- matrix(NA, nrow = length(timeSteps), ncol = nruns)

for(i in 1:nruns){
  # sim3List[[i]] <- seasonalPDmodel(parameterList, 
  #                                  nrc = nrc, 
  #                                  Tmax = Tmax, 
  #                                  numYears = numYears, 
  #                                  numPlantsRogued = 20, # No roguing
  #                                  vectorOverwintering = TRUE) # Vector overwintering
  # saveRDS(sim3List, file = "output/epidemic_simulation_scenario3_results_list.rds")
  sim3List <- readRDS("output/epidemic_simulation_scenario3_results_list.rds")
  #### Processing simulation results
  DiseaseData3[,i] <- sim3List[[i]]$Disease_times
  kappaData3[,i] <- c(sim3List[[i]]$kappaMatrix)
  #### Extracting and processing Exp_times results from each run
  infTimesProcessed <- processLatentInfections(sim3List[[i]]$Exp_times, numYears, Tmax, weekVector)
  ## Save just the cumulative infections times from each simulation, for now
  infectionTimesData3[,i] <- infTimesProcessed$cumulInfections
}


```

## Model results
### Dynamics of cumulative infections

```{r, sim1_cumulative_infections, fig.align='center', fig.cap='Simulation 1. Cumulative infections', echo = FALSE}


#### Calculate mean exposure times across simulations
infectionTimes <- data.frame(timeStep = timeSteps,
                             meanInfections = rowMeans(infectionTimesData1))
  

#### Final percentage of plants infected
sim1PercInfected <- 100*infectionTimes[infectionTimes$timeStep == max(infectionTimes$timeStep), "meanInfections"]/numPlants

#### Gather simulations for plotting each one as a separate line
plotSims <- infectionTimesData1 %>% as.data.frame() %>%
  mutate(timeStep = timeSteps) %>%
  pivot_longer(starts_with("V"), names_to = "simulation", values_to = "cumulInfections", names_prefix = "V")

#### Plot
infDynamicsPlot <- ggplot(data = plotSims, aes(x = timeStep, y = cumulInfections)) +
  #geom_line()
  geom_line(aes(group = simulation), lwd = 1, colour = "grey", alpha = 0.75) +
  geom_path(data = infectionTimes, aes(x = timeStep, y = meanInfections), colour = "black", lwd = 2) +
  # ## Add vertical lines indicating the end of each growing season/year
  geom_vline(data = endOfYears, aes(xintercept = timeStep), linetype = 2) +
  scale_x_continuous(name = "Weeks") +
  scale_y_continuous(name = "Mean cumulative number of latent infections",
                     sec.axis = sec_axis(~./numPlants, name = "Mean proportion of plants with latent infections")) +
  theme_bw(base_size=16) +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black"),
        panel.background = element_blank(),
        legend.position = "none")

infDynamicsPlot


```


```{r, sim2_cumulative_infections, fig.align='center', fig.cap='Simulation 2. Cumulative infections with vector overwintering', echo = FALSE}

#### Calculate mean exposure times across simulations
infectionTimes <- data.frame(timeStep = timeSteps,
                             meanInfections = rowMeans(infectionTimesData2))

#### Final percentage of plants infected
sim2PercInfected <- 100*infectionTimes[infectionTimes$timeStep == max(infectionTimes$timeStep), "meanInfections"]/numPlants

#### Gather simulations for plotting each one as a separate line
plotSims <- infectionTimesData2 %>% as.data.frame() %>%
  mutate(timeStep = timeSteps) %>%
  pivot_longer(starts_with("V"), names_to = "simulation", values_to = "cumulInfections", names_prefix = "V")

#### Plot
infDynamicsPlot <- ggplot(data = plotSims, aes(x = timeStep, y = cumulInfections)) +
  #geom_line()
  geom_line(aes(group = simulation), lwd = 1, colour = "grey", alpha = 0.75) +
  geom_path(data = infectionTimes, aes(x = timeStep, y = meanInfections), colour = "black", lwd = 2) +
  # ## Add vertical lines indicating the end of each growing season/year
  geom_vline(data = endOfYears, aes(xintercept = timeStep), linetype = 2) +
  scale_x_continuous(name = "Weeks") +
  scale_y_continuous(name = "Mean cumulative number of latent infections",
                     sec.axis = sec_axis(~./numPlants, name = "Mean proportion of plants with latent infections")) +
  theme_bw(base_size=16) +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black"),
        panel.background = element_blank(),
        legend.position = "none")

infDynamicsPlot


```


```{r, sim3_cumulative_infections, fig.align='center', fig.cap='Simulation 3. Cumulative infections with vector overwintering and roguing', echo = FALSE}

#### Calculate mean exposure times across simulations
infectionTimes <- data.frame(timeStep = timeSteps,
                             meanInfections = rowMeans(infectionTimesData3))

#### Final percentage of plants infected
sim3PercInfected <- 100*infectionTimes[infectionTimes$timeStep == max(infectionTimes$timeStep), "meanInfections"]/numPlants

#### Gather simulations for plotting each one as a separate line
plotSims <- infectionTimesData3 %>% as.data.frame() %>%
  mutate(timeStep = timeSteps) %>%
  pivot_longer(starts_with("V"), names_to = "simulation", values_to = "cumulInfections", names_prefix = "V")

#### Plot
infDynamicsPlot <- ggplot(data = plotSims, aes(x = timeStep, y = cumulInfections)) +
  geom_line(aes(group = simulation), lwd = 1, colour = "grey", alpha = 0.75) +
  geom_path(data = infectionTimes, aes(x = timeStep, y = meanInfections), colour = "black", lwd = 2) +
  ## Add vertical lines indicating the end of each growing season/year
  geom_vline(data = endOfYears, aes(xintercept = timeStep), linetype = 2) +
  scale_x_continuous(name = "Weeks") +
  scale_y_continuous(name = "Mean cumulative number of latent infections",
                     sec.axis = sec_axis(~./numPlants, name = "Mean proportion of plants with latent infections")) +
  theme_bw(base_size=16) +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black"),
        panel.background = element_blank(),
        legend.position = "none")

infDynamicsPlot


```

\ 

### Dynamics of in-field vector infectivity

```{r sim1_infectivity, fig.align="center", fig.cap="Simulation 1. In-field vector infectivity", echo = FALSE}

#### Kappa values for each time step
meanKappa <- data.frame(kappa = rowMeans(kappaData1),
                        timeStep = timeSteps)

#### Gather simulations for plotting each one as a separate line
plotKappaSims <- kappaData1 %>% as.data.frame() %>%
  mutate(timeStep = timeSteps) %>%
  pivot_longer(starts_with("V"), names_to = "simulation", values_to = "kappa", names_prefix = "V")


ggplot(data = plotKappaSims, aes(x = timeStep, y = kappa)) +
  geom_line(aes(group = simulation), lwd = 1, colour = "grey", alpha = 0.75) +
  geom_path(data = meanKappa, aes(x = timeStep, y = kappa), colour = "black", lwd = 2) +
  geom_vline(data = endOfYears, aes(xintercept = timeStep), linetype = 2) +
  scale_x_continuous(name = "Weeks") +
  scale_y_continuous(name = "Proportion of in-field vectors infectious") +
  theme_bw(base_size=16) +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black"),
        panel.background = element_blank(),
        legend.position = "none") 

```

```{r sim2_infectivity, fig.align="center", fig.cap="Simulation 2. In-field vector infectivity over time", echo = FALSE}

#### Kappa values for each time step
meanKappa <- data.frame(kappa = rowMeans(kappaData2),
                        timeStep = timeSteps)

#### Gather simulations for plotting each one as a separate line
plotKappaSims <- kappaData2 %>% as.data.frame() %>%
  mutate(timeStep = timeSteps) %>%
  pivot_longer(starts_with("V"), names_to = "simulation", values_to = "kappa", names_prefix = "V")


ggplot(data = plotKappaSims, aes(x = timeStep, y = kappa)) +
  geom_line(aes(group = simulation), lwd = 1, colour = "grey", alpha = 0.75) +
  geom_path(data = meanKappa, aes(x = timeStep, y = kappa), colour = "black", lwd = 2) +
  geom_vline(data = endOfYears, aes(xintercept = timeStep), linetype = 2) +
  scale_x_continuous(name = "Weeks") +
  scale_y_continuous(name = "Proportion of in-field vectors infectious") +
  theme_bw(base_size=16) +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black"),
        panel.background = element_blank(),
        legend.position = "none") 

```


```{r sim3_infectivity, fig.align="center", fig.cap="Simulation 3. In-field vector infectivity with vector overwintering", echo = FALSE}

#### Kappa values for each time step
meanKappa <- data.frame(kappa = rowMeans(kappaData3),
                        timeStep = timeSteps)

#### Gather simulations for plotting each one as a separate line
plotKappaSims <- kappaData3 %>% as.data.frame() %>%
  mutate(timeStep = timeSteps) %>%
  pivot_longer(starts_with("V"), names_to = "simulation", values_to = "kappa", names_prefix = "V")


ggplot(data = plotKappaSims, aes(x = timeStep, y = kappa)) +
  geom_line(aes(group = simulation), lwd = 1, colour = "grey", alpha = 0.75) +
  geom_path(data = meanKappa, aes(x = timeStep, y = kappa), colour = "black", lwd = 2) +
  geom_vline(data = endOfYears, aes(xintercept = timeStep), linetype = 2) +
  scale_x_continuous(name = "Weeks") +
  scale_y_continuous(name = "Proportion of in-field vectors infectious") +
  theme_bw(base_size=16) +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black"),
        panel.background = element_blank(),
        legend.position = "none") 

```

\ 

### Distribution of time of disease onset

```{r sim1_disease_time_distribution, fig.align='center', fig.cap='Simulation 1. Distribution of Disease times', echo = FALSE}

#### Calculate mode of Disease times for each plant across simulation runs
Disease_times <- sapply(DiseaseData1, mfv)
plotDiseaseTimes <- data.frame(dTimes = Disease_times[Disease_times < Tmax])

ggplot(plotDiseaseTimes, aes(x = dTimes)) +
  geom_histogram(binwidth = 1) +
  scale_x_continuous(name = "Disease times (weeks)") +
  scale_y_continuous(name = "Frequency") +
  theme_bw(base_size=16) +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black"),
        panel.background = element_blank(),
        legend.position = "none") 

```


```{r sim2_disease_time_distribution, fig.align='center', fig.cap='Simulation 2. Distribution of Disease times with vector overwintering', echo = FALSE}

#### Calculate mode of Disease times for each plant across simulation runs
Disease_times <- sapply(DiseaseData2, mfv)
plotDiseaseTimes <- data.frame(dTimes = Disease_times[Disease_times < Tmax])

ggplot(plotDiseaseTimes, aes(x = dTimes)) +
  geom_histogram(binwidth = 1) +
  scale_x_continuous(name = "Disease times (weeks)") +
  scale_y_continuous(name = "Frequency") +
  theme_bw(base_size=16) +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black"),
        panel.background = element_blank(),
        legend.position = "none") 

```


```{r sim3_disease_time_distribution, fig.align='center', fig.cap='Simulation 3. Distribution of Disease times with vector overwintering and roguing', echo = FALSE}

#### Calculate mode of Disease times for each plant across simulation runs
Disease_times <- sapply(DiseaseData3, mfv)
plotDiseaseTimes <- data.frame(dTimes = Disease_times[Disease_times < Tmax])

ggplot(plotDiseaseTimes, aes(x = dTimes)) +
  geom_histogram(binwidth = 1) +
  scale_x_continuous(name = "Disease times (weeks)") +
  scale_y_continuous(name = "Frequency") +
  theme_bw(base_size=16) +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black"),
        panel.background = element_blank(),
        legend.position = "none") 

```

\ 

### Spatial patterns of Disease

```{r sim1_map, fig.align='center', fig.cap='Simulation 1. Raster map of Disease patterns', echo = FALSE}

#### Pick a simulation at random
randsim <- sample(1:nruns, 1)
Coo <- sim1List[[randsim]]$Coo
Disease_times <- sim1List[[randsim]]$Disease_times

#### Produce raster with infection times as values
## Get raster dimensions from Coo
## Coo[,1] = rows or y coord
## Coo[,2] = columns or x coord
CooRows <- Coo[,1]
CooNrows <- length(unique(CooRows))
CooYmn <- min(CooRows)
CooYmx <- max(CooRows)
CooColumns <- Coo[,2]
CooNcols <- length(unique(CooColumns))
CooXmn <- min(CooColumns)
CooXmx <- max(CooColumns)

rasterTimes <- raster(nrows = CooNrows, ymn = CooYmn, ymx = CooYmx,
                      ncols = CooNcols, xmn = CooXmn, xmx = CooXmx,
                      vals = Disease_times)
plot(rasterTimes, main = "Week of year plant became diseased")

```


```{r sim2_map, fig.align='center', fig.cap='Simulation 2. Raster map of Disease patterns with vector overwintering', echo = FALSE}

#### Pick a simulation at random
randsim <- sample(1:nruns, 1)
Coo <- sim2List[[randsim]]$Coo
Disease_times <- sim2List[[randsim]]$Disease_times

#### Produce raster with infection times as values
## Get raster dimensions from Coo
## Coo[,1] = rows or y coord
## Coo[,2] = columns or x coord
CooRows <- Coo[,1]
CooNrows <- length(unique(CooRows))
CooYmn <- min(CooRows)
CooYmx <- max(CooRows)
CooColumns <- Coo[,2]
CooNcols <- length(unique(CooColumns))
CooXmn <- min(CooColumns)
CooXmx <- max(CooColumns)

rasterTimes <- raster(nrows = CooNrows, ymn = CooYmn, ymx = CooYmx,
                      ncols = CooNcols, xmn = CooXmn, xmx = CooXmx,
                      vals = Disease_times)
plot(rasterTimes, main = "Week of year plant became diseased")

```


```{r sim3_map, fig.align='center', fig.cap='Simulation 3. Raster map of Disease patterns with vector overwintering', echo = FALSE}

#### Pick a simulation at random
randsim <- sample(1:nruns, 1)
Coo <- sim3List[[randsim]]$Coo
Disease_times <- sim3List[[randsim]]$Disease_times

#### Produce raster with infection times as values
## Get raster dimensions from Coo
## Coo[,1] = rows or y coord
## Coo[,2] = columns or x coord
CooRows <- Coo[,1]
CooNrows <- length(unique(CooRows))
CooYmn <- min(CooRows)
CooYmx <- max(CooRows)
CooColumns <- Coo[,2]
CooNcols <- length(unique(CooColumns))
CooXmn <- min(CooColumns)
CooXmx <- max(CooColumns)

rasterTimes <- raster(nrows = CooNrows, ymn = CooYmn, ymx = CooYmx,
                      ncols = CooNcols, xmn = CooXmn, xmx = CooXmx,
                      vals = Disease_times)
plot(rasterTimes, main = "Week of year plant became diseased")

```

\ 

## Conclusions from comparing model runs

In the base model run (without vector overwintering) with 20 simulation runs, `r round(sim1PercInfected)`% of plants, on average, became latently infected by the end of `r numYears` years. There is a clear increase in infections over the years but the trajectories differ greatly among the different runs. With vector overwintering, the final percent of plants latently infected was `r round(sim2PercInfected)`%, nearly identical to the base simulation. Similarly, there is a wide variation in the trajectories of different simulation runs. So it's difficult to see differences between the scenarios without and with vector overwintering. 

However, the scenario with roguing shows consistent differences. When 20 diseased plants were rogued, infection prevalence was mostly kept in check with only small increases from year to year, on average; the final percent of plants infected was only at `r round(sim3PercInfected)`%. 

Similar dynamics can be seen in the in-field vector infectivity plots.

For the distribution of timing of disease onset, we see three peaks of disease onset throughout the growing season in the base model and with vector overwintering. With roguing, few plants become diseased (because they are removed) and the peaks are not as clear.

For the spatial patterns of disease, each model run shows a gradient of disease moving from left to right. With roguing, disease remained mostly on the left border of the field.

It seems that the stochasticity in the model simulations overwhelms the differences between the base model and the addition of vector overwintering. But with a relatively small amount of roguing, the epidemic was able to be effectively managed.